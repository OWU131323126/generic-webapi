<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ”® AIã«ã‚ˆã‚‹å ã„ AI Body Fortune</title>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a0033, #000);
      color: #fff;
      margin: 0;
    }

    .container {
      max-width: 640px;
      margin: auto;
      padding: 20px;
    }

    h1 { text-align: center; }

    .tabs {
      display: flex;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
      border-radius: 12px 12px 0 0;
      opacity: 0.6;
    }

    .tab.active {
      background: linear-gradient(135deg, #7f5cff, #5ad7ff);
      opacity: 1;
      font-weight: bold;
    }

    .panel { display: none; }
    .panel.active { display: block; }

    .card {
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 0 30px rgba(122,100,255,0.25);
    }

    label { margin-top: 10px; display: block; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: none;
      background: #111;
      color: white;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 14px;
      border-radius: 999px;
      border: none;
      font-weight: bold;
      background: linear-gradient(135deg, #7f5cff, #5ad7ff);
      color: white;
      cursor: pointer;
    }

    .result { margin-top: 16px; }

    .fortune {
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .chat {
      background: #111;
      padding: 12px;
      border-radius: 12px;
      height: 320px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .msg { margin-bottom: 10px; }

    .user { color: #5ad7ff; font-weight: bold; }
    .western { color: #ffb347; }
    .eastern { color: #7fff7f; }
    .science { color: #5ad7ff; }

    #chatLoading {
      text-align: center;
      opacity: 0.8;
      animation: blink 1.2s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    canvas { display: block; margin: 20px auto; }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ”® AIã«ã‚ˆã‚‹å ã„ AI Body Fortune</h1>

  <div class="tabs">
    <div class="tab active" onclick="openTab(0)">å ã„</div>
    <div class="tab" onclick="openTab(1)">AIãƒãƒ£ãƒƒãƒˆ</div>
  </div>

  <!-- ===== å ã„ ===== -->
  <div class="panel active">
    <div class="card">
      <label>ç”Ÿå¹´æœˆæ—¥</label>
      <input type="date" id="birthDate">

      <label>ç¡çœ ã®è³ª</label>
      <select id="sleep">
        <option value="è‰¯ã„">ã‚ˆãçœ ã‚ŒãŸ</option>
        <option value="æ™®é€š">æ™®é€š</option>
        <option value="æ‚ªã„">ã»ã¨ã‚“ã©çœ ã‚Œã¦ã„ãªã„</option>
      </select>

      <label>ä»Šæ—¥ã®æ°—åˆ†</label>
      <select id="mood">
        <option value="è‰¯ã„">ğŸ˜„ è‰¯ã„</option>
        <option value="æ™®é€š">ğŸ˜ æ™®é€š</option>
        <option value="æ‚ªã„">ğŸ˜£ æ‚ªã„</option>
      </select>

      <label>ä½“ã®èª¿å­</label>
      <select id="body">
        <option value="è‰¯ã„">å…ƒæ°—</option>
        <option value="æ™®é€š">å°‘ã—ã ã‚‹ã„</option>
        <option value="æ‚ªã„">ç—›ã¿ãƒ»ä¸èª¿ãŒã‚ã‚‹</option>
      </select>

      <label>ã‚¹ãƒˆãƒ¬ã‚¹</label>
      <select id="stress">
        <option value="ä½ã„">ãªã„</option>
        <option value="æ™®é€š">å°‘ã—ã‚ã‚‹</option>
        <option value="é«˜ã„">å¼·ã„</option>
      </select>

      <button onclick="generateFortune()">å ã†</button>
    </div>

    <div id="loading" style="display:none;">ğŸ”® å ã„ä¸­â€¦</div>
    <div class="result" id="result"></div>
  </div>

  <!-- ===== AIãƒãƒ£ãƒƒãƒˆ ===== -->
  <div class="panel">
  <div id="chatLoading" style="display:none; text-align:center;">ğŸ’¬ é€ä¿¡ä¸­â€¦</div>
  <div class="chat" id="chat"></div>
  <textarea id="chatInput"></textarea>
  <button onclick="sendChat()">é€ä¿¡</button>
</div>


<script>
  function openTab(i) {
    document.querySelectorAll('.tab').forEach((t,n)=>t.classList.toggle('active',n===i));
    document.querySelectorAll('.panel').forEach((p,n)=>p.classList.toggle('active',n===i));
  }

  /* ===== å ã„ ===== */
  async function generateFortune() {
    loading.style.display = 'block';

    const res = await fetch('/api/fortune', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        birthDate: birthDate.value,
        health: {
          sleep: sleep.value,
          mood: mood.value,
          body: body.value,
          stress: stress.value
        }
      })
    });

    const data = await res.json();
    loading.style.display = 'none';

    result.innerHTML = '';
    for (const k in data.fortunes) {
      const f = data.fortunes[k];
      result.innerHTML += `
        <div class="fortune ${k}">
          <strong>${f.type}</strong>
          <p>${f.result}</p>
          <p>é‹å‹¢ï¼š${f.luck}</p>
        </div>`;
    }
  }

  /* ===== AIãƒãƒ£ãƒƒãƒˆ ===== */
  const socket = io();
  const chat = document.getElementById('chat');
  const input = document.getElementById('chatInput');
  const chatLoading = document.getElementById('chatLoading');

  function sendChat() {
    const text = input.value.trim();
    if (!text) return;

    chat.innerHTML += `<div class="msg user">ğŸ‘¤ ${text}</div>`;
    chatLoading.style.display = 'block';   // â† è¡¨ç¤º
    socket.emit('user-message', text);
    input.value = '';
  }

  socket.on('ai-message', d => {
    chatLoading.style.display = 'none';    // â† éè¡¨ç¤º
    chat.innerHTML += `
      <div class="msg ${d.agent}">
        <strong>${d.name}</strong><br>
        ${d.message}
      </div>`;
    chat.scrollTop = chat.scrollHeight;
  });
</script>

<script>
let angle = 0;
function setup() {
  const c = createCanvas(260,260,WEBGL);
  c.parent(document.body);
}
function draw() {
  background(0);
  rotateY(angle);
  ambientLight(180);
  ambientMaterial(120,120,255);
  sphere(90);
  angle += 0.01;
}
</script>

</body>
</html>
